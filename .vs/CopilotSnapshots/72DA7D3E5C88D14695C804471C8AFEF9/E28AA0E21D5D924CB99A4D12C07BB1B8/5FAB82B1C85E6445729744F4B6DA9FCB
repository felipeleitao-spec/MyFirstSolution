using Microsoft.AspNetCore.Mvc;
using MyFirstSolution.Models;

namespace MyFirstSolution.Controllers
{
    [ApiController]
    [Route("nutrition")]
    public class NutritionController : ControllerBase
    {
        [HttpPost("calculate")]
        public ActionResult<NutritionResponse> Calculate([FromBody] NutritionRequest request)
        {
            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            // Calculate BMR using Mifflin-St Jeor equation
            // Male: BMR = 10*weight + 6.25*height - 5*age + 5
            // Female: BMR = 10*weight + 6.25*height - 5*age - 161
            double bmr = 10 * request.WeightKg + 6.25 * request.HeightCm - 5 * request.Age + (request.Sex == Sex.Male ? 5 : -161);

            // Activity multipliers
            double activityMultiplier = request.ActivityLevel switch
            {
                ActivityLevel.Sedentary => 1.2,
                ActivityLevel.LightlyActive => 1.375,
                ActivityLevel.ModeratelyActive => 1.55,
                ActivityLevel.VeryActive => 1.725,
                ActivityLevel.ExtraActive => 1.9,
                _ => 1.2
            };

            double tdee = bmr * activityMultiplier;

            double deficitPercent = request.DeficitPercent.HasValue && request.DeficitPercent.Value > 0 ? request.DeficitPercent.Value : 20.0;
            double targetCalories = tdee * (1 - deficitPercent / 100.0);

            // Macronutrient split recommendation for weight loss (default):
            // Protein: 30% of calories (4 kcal/g), Carbs: 40% (4 kcal/g), Fat: 30% (9 kcal/g)
            double proteinPercent = 30;
            double carbsPercent = 40;
            double fatPercent = 30;

            double proteinCalories = targetCalories * (proteinPercent / 100.0);
            double carbsCalories = targetCalories * (carbsPercent / 100.0);
            double fatCalories = targetCalories * (fatPercent / 100.0);

            double proteinGrams = proteinCalories / 4.0;
            double carbsGrams = carbsCalories / 4.0;
            double fatGrams = fatCalories / 9.0;

            var suggestion = new MacronutrientSuggestion
            {
                Calories = Math.Round(targetCalories, 0),
                ProteinGrams = Math.Round(proteinGrams, 0),
                CarbsGrams = Math.Round(carbsGrams, 0),
                FatGrams = Math.Round(fatGrams, 0),
                ProteinPercent = proteinPercent,
                CarbsPercent = carbsPercent,
                FatPercent = fatPercent
            };

            var response = new NutritionResponse
            {
                BMR = Math.Round(bmr, 0),
                TDEE = Math.Round(tdee, 0),
                TargetCalories = Math.Round(targetCalories, 0),
                Suggestion = suggestion
            };

            return Ok(response);
        }
    }
}
